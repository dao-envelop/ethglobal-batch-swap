name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: ci

jobs:
  check:
    name: Foundry project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Show Forge version
        run: |
          forge --version

      - name: Run Forge fmt
        run: |
          cd smart-wallet
          forge fmt --check
        id: fmt

      - name: Run Forge build
        run: |
          cd smart-wallet 
          forge build --sizes
        id: build

      - name: Run Forge tests
        run: |
          cd smart-wallet
          forge test -vvv
        id: test

  deploy:
    name: Deploy docker frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30 
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy frontend to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST2 }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY2 }}
          source: "frontend/*"
          target: "~/eth-global"

      - name: Build and run container on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST2 }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY2 }}
          script: |
            cd ~/eth-global/frontend
            docker compose --profile stage down
            docker compose --profile stage up -d

  deploy:
    name: Deploy Api in docker
    runs-on: ubuntu-latest
    timeout-minutes: 30 
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy api to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST2 }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY2 }}
          source: "api/*"
          target: "~/eth-global"

      - name: Build and run container on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST2 }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY2 }}
          script: |
            cd ~/eth-global/api
            docker compose --profile stage down
            docker compose --profile stage up -d